CURRENT = 0
REVISION = 0
AGE = 0
STUBSCURRENT = 0
STUBSREVISION = 0
STUBSAGE = 0
include ../Makefile.common

top_srcdir=@top_srcdir@
top_builddir=../..
abs_top_builddir := $(shell cd $(top_builddir); pwd)
abs_builddir := $(shell pwd)
srcdir=@srcdir@

include $(top_builddir)/etc/Makefile.common

SHELL=@SHELL@
RANLIB=@RANLIB@
INSTALL=@INSTALL@
LIBTOOL=@LIBTOOL@
DLLWRAP=@DLLWRAP@

VPATH=$(srcdir)

JAVAINCLUDES=@JAVAINCLUDES@

override CPPFLAGS += $(JAVAINCLUDES) -I$(top_builddir)/libobjc -I$(top_srcdir)/libobjc -I$(top_srcdir)/src/misc -I$(top_builddir) -I$(top_builddir)/src -I$(top_srcdir)/src $(foreach module,$(MODULES),-I$(top_builddir)/src/$(module) -I$(top_srcdir)/src/$(module)) -I$(srcdir)

# Solaris JNI headers have some pragmas
override CFLAGS += @CFLAGS_NOWARN_UNKNOWN_PRAGMAS@
override OBJCFLAGS += @CFLAGS_NOWARN_UNKNOWN_PRAGMAS@

modulePROTOCOLS = $(foreach module,$(MODULES),$($(module)PROTOCOLS))

libjavaswarmstubs__la_OBJECTS = $(addsuffix .lo,$(modulePROTOCOLS))
libjavaswarm__la_OBJECTS = setup.lo SwarmEnvironment.lo

JAVASWARM_DLL = @JAVASWARM_DLL@
LIBJAVASWARM_LA = @LIBJAVASWARM_LA@
LIBJAVASWARMSTUBS_LA = @LIBJAVASWARMSTUBS_LA@

all: $(JAVASWARM_DLL) $(LIBJAVASWARM_LA) $(LIBJAVASWARMSTUBS_LA)

install: all
	if test -z "$(JAVASWARM_DLL)"; then \
	  $(LIBTOOL) --mode=install $(INSTALL) libjavaswarm.la $(libdir) \
	  $(LIBTOOL) --mode=install $(INSTALL) libjavaswarmstubs.la $(libdir) \
	  $(LIBTOOL) --mode=finish $(libdir) \
	else \
	  $(INSTALL) javaswarm.dll $(bindir) \
	  $(INSTALL) libjavaswarm.a $(libdir) \
	  $(RANLIB) $(libdir)/libjavaswarm.a \
	fi

libjavaswarmstubs_.la: $(libjavaswarmstubs__la_OBJECTS)
	$(LIBTOOL) --mode=link $(OBJC) $(CFLAGS) -o $@ $(libjavaswarmstubs__la_LDFLAGS) $(libjavaswarmstubs__la_OBJECTS)

libjavaswarm_.la: $(libjavaswarm__la_OBJECTS)
	$(LIBTOOL) --mode=link $(OBJC) $(CFLAGS) -o $@ $(libjavaswarm__la_OBJECTS)

libjavaswarmstubs.la: libjavaswarmstubs_.la
	$(LIBTOOL) --mode=link $(OBJC) $(CFLAGS) -o $@ -version-info $(STUBSCURRENT):$(STUBSREVISION):$(STUBSAGE) -rpath $(libdir) libjavaswarmstubs_.la

libjavaswarm.la: libjavaswarmstubs.la libjavaswarm_.la
	$(LIBTOOL) --mode=link $(OBJC) $(CFLAGS) -o $@ -version-info $(CURRENT):$(REVISION):$(AGE) -L$(abs_top_builddir)/src -rpath $(libdir) libjavaswarm_.la libjavaswarmstubs.la $(SWARMLIBS)

ALLOBJECTS = $(patsubst %.lo,%.o,$(libjavaswarm__la_OBJECTS) $(libjavaswarmstubs__la_OBJECTS))

javaswarm.dll: libjavaswarm_.la libjavaswarmstubs_.la
	$(CC) -Dconstructor_func=javaswarm_constructor -c $(top_srcdir)/src/dllinit.c -o javaswarm_dllinit.o
	$(top_srcdir)/src/genctors javaswarm_constructor $(ALLOBJECTS)
	$(CC) -c javaswarm_constructor.c
	$(DLLWRAP) --export-all --output-def javaswarm.def --implib libjavaswarm.a --driver-name $(CC) -o javaswarm.dll javaswarm_dllinit.o javaswarm_constructor.o $(ALLOBJECTS) -L../libobjc -L$(top_builddir)/src $(SWARMLIBS) -lobjc

%.lo: %.m
	$(LIBTOOL) --mode=compile $(OBJC) $(CPPFLAGS) $(OBJCFLAGS) -c $<

%.lo: %.c
	$(LIBTOOL) --mode=compile $(CC) $(CPPFLAGS) $(CFLAGS) -c $<

