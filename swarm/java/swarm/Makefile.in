prefix=@prefix@
datadir=@datadir@
jdkdir=@jdkdir@
INSTALL=@INSTALL@
jdkdir=@jdkdir@
jdkbindir=$(jdkdir)/bin
JAR=$(jdkbindir)/jar
JAVAC=$(jdkbindir)/javac
JAVACLASSES=@JAVACLASSES@
srcdir=@srcdir@
VPATH=$(srcdir)

include ../Makefile.common

CLASSPHASES := __c U
INTERFACEPHASES := $(CLASSPHASES) S

PRECLASSES = NonUniqueMethodSignatureException SignatureNotFoundException Selector
POSTCLASSES = SwarmEnvironment 
PRECLASSFILES = $(addsuffix .class,$(PRECLASSES))
POSTCLASSFILES = $(addsuffix .class,$(POSTCLASSES))
SWARMCLASSFILES = $(addprefix swarm/,$(PRECLASSFILES) $(POSTCLASSFILES))

GENCLASSFILES := $(addsuffix .class,$(foreach module,$(MODULES),$(addprefix swarm/$(module)/,$(subst __c,,$(foreach sfx,$(CLASSPHASES),$(addsuffix $(sfx),$($(module)PROTOCOLS)))))))

GENINTERFACEFILES := $(addsuffix .class,$(foreach module,$(MODULES),$(addprefix swarm/$(module)/,$(subst __c,,$(foreach sfx,$(INTERFACEPHASES),$(addsuffix $(sfx),$(addprefix i_,$($(module)PROTOCOLS))))))))

all: modules $(POSTCLASSFILES)

deps: 
	for module in $(MODULES); do $(MAKE) -C $$module .deps; done

modules: deps $(PRECLASSFILES)
	for module in $(MODULES); do $(MAKE) -C $$module all; done
	cd .. ; JAVA_HOME=$(jdkdir) $(JAR) cf swarm/swarm.jar $(SWARMCLASSFILES) $(GENCLASSFILES) $(GENINTERFACEFILES)

install: all
	test -d $(datadir) || mkdir $(datadir)
	test -d $(datadir)/swarm || mkdir $(datadir)/swarm
	$(INSTALL) swarm.jar $(datadir)/swarm

%.class: %.java
	JAVA_HOME=$(jdkdir) $(JAVAC) -d .. -classpath $(srcdir)/..:../:$(JAVACLASSES) $<
