prefix=@prefix@
datadir=@datadir@
jdkdir=@jdkdir@
jdkdosdir=@jdkdosdir@
INSTALL=@INSTALL@
jdkdir=@jdkdir@
jdkbindir=$(jdkdir)/bin
JAR=@JAR@
JAVAC=@JAVAC@
JAVACLASSES=@JAVACLASSES@
srcdir=@srcdir@
VPATH=$(srcdir)

include ../Makefile.common

CLASSPHASES := __c U
INTERFACEPHASES := $(CLASSPHASES) S

PRECLASSES = NonUniqueMethodSignatureException SignatureNotFoundException Selector
POSTCLASSES = SwarmEnvironment
PRECLASSFILES = $(addsuffix .class,$(PRECLASSES))
POSTCLASSFILES = $(addsuffix .class,$(POSTCLASSES))
SWARMCLASSFILES = $(addprefix swarm/,$(PRECLASSFILES) $(POSTCLASSFILES))

define module-class-files
$(addsuffix .class,$(addprefix swarm/$(module)/,$(subst __c,,$(foreach sfx,$(CLASSPHASES),$(addsuffix $(sfx),$($(module)PROTOCOLS))))))
endef

define module-interface-files
$(addsuffix .class,$(addprefix swarm/$(module)/,$(subst __c,,$(foreach sfx,$(INTERFACEPHASES),$(addsuffix $(sfx),$(addprefix i_,$($(module)PROTOCOLS)))))))
endef

GENCLASSFILES := $(foreach module,$(MODULES),$(module-class-files))

GENINTERFACEFILES := $(foreach module,$(MODULES),$(module-interface-files))

ALLCLASSFILES = $(SWARMCLASSFILES) $(GENCLASSFILES) $(GENINTERFACEFILES)

all: modules $(POSTCLASSFILES)

deps: 
	for module in $(MODULES); do $(MAKE) -C $$module .deps; done

modules: deps $(PRECLASSFILES)
	for module in $(MODULES); do $(MAKE) -C $$module all; done

jar: all
	cd .. ; unset CLASSPATH ; $(JAR) cf swarm/swarm.jar $(ALLCLASSFILES)

install-java-classes-as-jar: jar
	test -d $(datadir) || mkdir $(datadir)
	test -d $(datadir)/swarm || mkdir $(datadir)/swarm
	$(INSTALL) swarm.jar $(datadir)/swarm

install-java-classes-as-files: all
	test -d $(datadir) || mkdir $(datadir)
	$(RM) ../filelist
	for f in $(SWARMCLASSFILES); do echo $$f >> ../filelist ; done
	$(foreach module,$(MODULES),for f in $(module-class-files); do echo $$f >> ../filelist; done;)
	$(foreach module,$(MODULES),for f in $(module-interface-files); do echo $$f >> ../filelist; done;)
	(cd ..; tar -c -f - -T filelist) | (cd $(datadir); tar xf -)
	$(RM) ../filelist

install: install-java-classes-as-@JAVA_CLASSES_INSTALLED_AS@

# for the non-generated Java (the other rules from JavaDep use JAVACOMPILE)
%.class: %.java
	$(JAVAC) -d .. -classpath '..@PATHSEP@$(JAVACLASSES)' @PATHEXPR@
